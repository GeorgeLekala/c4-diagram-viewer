<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>ArchViz - Workspace</title>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-sitemap"></i> ArchViz</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item"><i class="fas fa-home"></i> Home</a>
                <div id="systems-nav" class="nav-group"></div>
            </nav>
        </aside>
        <main class="main-content">
            <header>
                <h1 id="page-title">Workspace</h1>
            </header>
            <section class="systems-section" id="systems-section">
                <h2>Systems</h2>
                <div class="add-system">
                    <input type="text" id="new-system-name" placeholder="Enter system name">
                    <button id="add-system-btn"><i class="fas fa-plus"></i> Add System</button>
                </div>
                <div id="systems-list" class="systems-list"></div>
            </section>
            <section class="diagram-editor" style="display: none;" id="diagram-editor">
                <h2>Edit Diagram</h2>
                <div class="editor-controls">
                    <select id="diagram-type">
                        <option value="context">Context</option>
                        <option value="containers">Containers</option>
                        <option value="components">Components</option>
                    </select>
                    <textarea id="puml-code" rows="10" placeholder="Enter PlantUML C4 code..."></textarea>
                    <textarea id="explanation" rows="5" placeholder="Enter explanation..."></textarea>
                    <div class="editor-actions">
                        <button id="preview-btn"><i class="fas fa-eye"></i> Preview</button>
                        <button id="reset-preview-btn"><i class="fas fa-undo"></i> Reset Preview</button>
                        <button id="save-btn"><i class="fas fa-save"></i> Save</button>
                    </div>
                </div>
                <div id="preview-output" class="preview-output"></div>
                <p class="help-text">Use C4 model syntax (e.g., !include C4-PlantUML). Click elements in the preview to drill down.</p>
            </section>
        </main>
    </div>

    <script>
        let systems = {};
        let currentSystem = null;

        function loadSystems() {
            systems["System X"] = {
                context: { puml: "@startuml\n!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml\ntitle System Context Diagram for System X\nPerson(user, \"User\", \"A person interacting with System X\") [[/diagram/System X/context]]\nSystem(sys_x, \"System X\", \"The core application providing key functionality\") [[/diagram/System X/containers]]\nSystem_Ext(ext_sys, \"External System\", \"An external service providing data or functionality\")\nRel(user, sys_x, \"Uses\", \"HTTPS\")\nRel(sys_x, ext_sys, \"Integrates with\", \"API/JSON\")\nSHOW_LEGEND()\n@enduml", md: "# System X Context Diagram\nThis diagram shows the high-level context of System X, including:\n- **User**: Interacts with System X via HTTPS.\n- **System X**: The core application.\n- **External System**: Provides data via API/JSON." },
                containers: { puml: "@startuml\n!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml\ntitle Container Diagram for System X\nPerson(user, \"User\", \"A person interacting with System X\")\nSystem_Boundary(c1, \"System X\") {\n    Container(web_app, \"Web App\", \"JavaScript, React\", \"Delivers the user interface\")\n    Container(api, \"API\", \"Java, Spring Boot\", \"Handles business logic and data\") [[/diagram/System X/components]]\n    ContainerDb(db, \"Database\", \"PostgreSQL\", \"Stores application data\")\n}\nSystem_Ext(ext_sys, \"External System\", \"Provides data or functionality\")\nRel(user, web_app, \"Uses\", \"HTTPS\")\nRel(web_app, api, \"Calls\", \"JSON/HTTPS\")\nRel(api, db, \"Reads/Writes\", \"JDBC\")\nRel(api, ext_sys, \"Integrates with\", \"API/JSON\")\nSHOW_LEGEND()\n@enduml", md: "# System X Container Diagram\nThis diagram zooms into System X, showing:\n- **Web App**: Delivers the UI using React.\n- **API**: Handles logic with Spring Boot.\n- **Database**: Stores data in PostgreSQL.\n- **External System**: Integrated via API/JSON." },
                components: { puml: "@startuml\n!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml\ntitle Component Diagram for System X API\nContainer_Boundary(api, \"API\") {\n    Component(controller, \"Controller\", \"Spring MVC\", \"Handles HTTP requests\")\n    Component(service, \"Service\", \"Spring Bean\", \"Implements business logic\")\n    Component(repo, \"Repository\", \"Spring Data\", \"Manages database access\")\n}\nContainerDb(db, \"Database\", \"PostgreSQL\", \"Stores application data\")\nRel(controller, service, \"Uses\")\nRel(service, repo, \"Uses\")\nRel(repo, db, \"Reads/Writes\", \"JDBC\")\nSHOW_LEGEND()\n@enduml", md: "# System X API Component Diagram\nThis diagram details the API container:\n- **Controller**: Handles HTTP requests.\n- **Service**: Implements business logic.\n- **Repository**: Manages database access." }
            };
            updateSystemsList();
            updateSidebar();
        }

        function updateSystemsList() {
            const list = document.getElementById('systems-list');
            list.innerHTML = '';
            for (let system in systems) {
                const div = document.createElement('div');
                div.className = 'system-card';
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit Diagrams';
                editButton.dataset.system = system;
                editButton.addEventListener('click', () => editSystem(system));
                div.innerHTML = `<h3><i class="fas fa-cube"></i> ${system}</h3>`;
                div.appendChild(editButton);
                list.appendChild(div);
            }
        }

        function updateSidebar() {
            const navGroup = document.getElementById('systems-nav');
            navGroup.innerHTML = '';
            for (let system in systems) {
                const link = document.createElement('a');
                link.href = `/diagram/${system}/context`;
                link.className = 'nav-item';
                link.innerHTML = `<i class="fas fa-cube"></i> ${system}`;
                navGroup.appendChild(link);
            }
        }

        function addSystem() {
            const name = document.getElementById('new-system-name').value.trim();
            if (name && !systems[name]) {
                systems[name] = {
                    context: { puml: "", md: "" },
                    containers: { puml: "", md: "" },
                    components: { puml: "", md: "" }
                };
                document.getElementById('new-system-name').value = '';
                updateSystemsList();
                updateSidebar();
            }
        }

        function editSystem(systemName) {
            currentSystem = systemName;
            document.getElementById('diagram-editor').style.display = 'block';
            document.getElementById('page-title').textContent = `${systemName} - Edit`;
            updateSidebar();
        }

        function updateNav() {
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            navLinks.forEach(link => {
                if (link.href.includes(currentSystem)) link.className = 'nav-item current';
                else link.className = 'nav-item';
            });
        }

        async function previewDiagram() {
            const type = document.getElementById('diagram-type').value;
            const pumlCode = document.getElementById('puml-code').value;
            const explanation = document.getElementById('explanation').value;

            if (currentSystem && pumlCode) {
                try {
                    console.log('Sending preview request with:', pumlCode);
                    const response = await fetch('/preview', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pumlCode })
                    });
                    console.log('Response status:', response.status);
                    const result = await response.json();
                    console.log('Response data:', result);
                    if (response.ok) {
                        document.getElementById('preview-output').innerHTML = `<div>${result.svg}</div><p>${explanation}</p>`;
                    } else {
                        document.getElementById('preview-output').innerHTML = `<p style="color:red;">${result.error || 'Error rendering diagram.'}</p>`;
                    }
                } catch (err) {
                    console.error('Fetch error:', err);
                    document.getElementById('preview-output').innerHTML = `<p style="color:red;">Failed to preview diagram: ${err.message}</p>`;
                }
            }
        }

        function saveDiagram() {
            if (currentSystem) {
                const type = document.getElementById('diagram-type').value;
                systems[currentSystem][type].puml = document.getElementById('puml-code').value;
                systems[currentSystem][type].md = document.getElementById('explanation').value;
                alert('Diagram saved!');
                document.getElementById('diagram-editor').style.display = 'none';
                document.getElementById('preview-output').innerHTML = '';
            }
        }

        function resetPreview() {
            document.getElementById('preview-output').innerHTML = '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSystems();
            document.getElementById('add-system-btn').addEventListener('click', addSystem);
            document.getElementById('preview-btn').addEventListener('click', previewDiagram);
            document.getElementById('save-btn').addEventListener('click', saveDiagram);
            document.getElementById('reset-preview-btn').addEventListener('click', resetPreview);
        });
    </script>
</body>
</html>